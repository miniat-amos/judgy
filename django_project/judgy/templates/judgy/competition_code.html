{% extends 'judgy/base_competition.html' %}

{% block title %}{{ competition.name }}{% endblock %}

{% block style %}

<style>

  .card-border {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card-border:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    border-color: white;
  }

  .rankings-wrapper {
    position: relative;
  }

  .ranking-card {
    position: relative;
    transform: translate(var(--translate-x, 0), var(--translate-y, 0)) scale(var(--scale, 1));
    transition: transform 420ms cubic-bezier(0.23, 1, 0.32, 1), box-shadow 420ms ease;
    will-change: transform;
  }

  .ranking-card.ranking-floating {
    z-index: 5;
    box-shadow: 0 22px 32px rgba(0, 0, 0, 0.25);
  }

  .ranking-card .card-body {
    transition: transform 420ms cubic-bezier(0.23, 1, 0.32, 1);
  }

  #rankings {
    margin-top: 5px;
  }
 
  .plus-icon { 
    font-size: 200px; 
  }

</style>


{% endblock %}

{% block main_competition %}

<script>
  $(async () => {
    {% if submission_form %}
    $('#submission').on('show.bs.modal', event => {
      const $trigger = $(event.relatedTarget);
      $('#submission .title').text(`${$trigger.data('number')}. ${$trigger.data('name')}`);
      $('#submission')
        .closest('form')
        .attr(
          'action',
          "{% url 'competition:submit' competition.code 'problem.name' %}".replace(
            'problem.name',
            $trigger.data('name')
          )
        );
    });
    {% else %}
    $('[data-bs-target="#submission"]').remove();
    $('#submission').closest('form').remove();
    {% endif %}

    $('#submit-submission').on('submit', async function (e) {
      e.preventDefault();

      const form = $(this);
      const actionUrl = form.closest('form').attr('action');
      const fileInput = $('#user-submission-files')[0];
      const files = fileInput.files;
      const formData = new FormData();

      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }

      try {
        const response = await fetch(actionUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: formData,
        });

        await response.json();
        $('#submission').modal('hide');
        form.trigger('reset');
      } catch (err) {
        console.error('Upload error:', err);
        alert('Error submitting file.');
      }

      return false;
    });

    const competitionCode = '{{ competition.code }}';
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const scoreSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/scores/${competitionCode}/`);
    const rankingsContainer = $('#rankings');
    const teamUrlTemplate = "{% url 'competition:team_name' competition.code 'team.name' %}";
    const transitionTiming = '420ms cubic-bezier(0.23, 1, 0.32, 1)';

    function teamUrl(teamName) {
      return teamUrlTemplate.replace('team.name', encodeURIComponent(teamName));
    }

    function buildMembersHtml(members) {
      if (!members || !members.length) {
        return `
          <div class="col">
            <div class="text-center text-muted">
              <i class="bi bi-person-circle" style="font-size: 4rem"></i>
              <h4>â€”</h4>
            </div>
          </div>
        `;
      }

      return members
        .map(
          (member) => `
        <div class="col">
          <div class="text-center">
            <i class="bi bi-person-circle" style="font-size: 4rem"></i>
            <h4>${member}</h4>
          </div>
        </div>
      `
        )
        .join('');
    }

    function setRankText(card, rank) {
      card.querySelector('.team-rank').textContent = `Rank: #${rank}`;
    }

    function updateRankingCard(card, team, { deferRankUpdate = false } = {}) {
      card.dataset.teamId = team.team_id;
      card.dataset.pendingRank = team.rank;
      card.querySelector('.team-name').textContent = team.team_name;
      card.querySelector('.team-name').href = teamUrl(team.team_name);
      card.querySelector('.rank-members').innerHTML = buildMembersHtml(team.members);

      if (!deferRankUpdate) {
        setRankText(card, team.rank);
      }
    }

    function createRankingCard(team) {
      const wrapper = document.createElement('div');
      wrapper.className = 'card bg-body-tertiary ranking-card mb-3';
      wrapper.setAttribute('data-team-id', team.team_id);
      wrapper.setAttribute('data-rank', team.rank);
      wrapper.innerHTML = `
        <div class="card-body">
          <h2 class="card-title team-rank"></h2>
          <h3 class="card-title">
            Team:
            <a class="text-decoration-none team-name" href="#"></a>
          </h3>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 rank-members"></div>
        </div>
      `;
      updateRankingCard(wrapper, team);
      return wrapper;
    }

    function measurePositions(container) {
      const map = new Map();
      container.querySelectorAll('[data-team-id]').forEach(card => {
        const rect = card.getBoundingClientRect();
        map.set(card.dataset.teamId, {
          rect,
          rank: Number(card.dataset.rank || 0),
        });
      });
      return map;
    }

    function applyFlip(card, prevRect, nextRect, rankChanged) {
      const deltaX = prevRect.rect.left - nextRect.rect.left;
      const deltaY = prevRect.rect.top - nextRect.rect.top;

      if (!deltaX && !deltaY) {
        if (rankChanged) {
          setRankText(card, card.dataset.pendingRank);
          card.dataset.rank = card.dataset.pendingRank;
        }
        return;
      }

      card.style.transition = 'none';
      card.style.setProperty('--translate-x', `${deltaX}px`);
      card.style.setProperty('--translate-y', `${deltaY}px`);

      requestAnimationFrame(() => {
        card.classList.add('ranking-floating');
        card.style.transition = `transform ${transitionTiming}, box-shadow ${transitionTiming}`;
        card.style.setProperty('--translate-x', '0px');
        card.style.setProperty('--translate-y', '0px');
        card.style.setProperty('--scale', rankChanged ? '1.06' : '1');

        let finalized = false;
        const finalize = () => {
          if (finalized) {
            return;
          }
          finalized = true;
          card.classList.remove('ranking-floating');
          card.style.removeProperty('--scale');

          if (rankChanged) {
            setRankText(card, card.dataset.pendingRank);
          }
          card.dataset.rank = card.dataset.pendingRank;
        };
        const onEnd = (event) => {
          if (event.propertyName !== 'transform') {
            return;
          }
          finalize();
        };
        card.addEventListener('transitionend', onEnd, { once: true });
        setTimeout(finalize, 480);
      });
    }

    function renderRankings(rankings) {
      if (!rankingsContainer.length) {
        return;
      }

      const containerEl = rankingsContainer[0];
      const previousPositions = measurePositions(containerEl);
      const cardsById = new Map();
      containerEl.querySelectorAll('[data-team-id]').forEach(card => {
        cardsById.set(card.dataset.teamId, card);
      });

      const fragment = document.createDocumentFragment();
      const seenIds = new Set();

      rankings.forEach(team => {
        const teamId = String(team.team_id);
        let card = cardsById.get(teamId);
        const prevRank = card ? Number(card.dataset.rank || 0) : null;
        const rankChanged = prevRank !== null && prevRank !== team.rank;

        if (!card) {
          card = createRankingCard(team);
        } else {
          updateRankingCard(card, team, { deferRankUpdate: rankChanged });
        }

        card.dataset.rank = team.rank;
        card.dataset.pendingRank = team.rank;
        card.dataset.rankChanged = rankChanged ? '1' : '0';
        fragment.appendChild(card);
        seenIds.add(teamId);
      });

      cardsById.forEach((card, id) => {
        if (!seenIds.has(id)) {
          card.remove();
        }
      });

      containerEl.appendChild(fragment);

      const nextPositions = measurePositions(containerEl);
      containerEl.querySelectorAll('[data-team-id]').forEach(card => {
        const teamId = card.dataset.teamId;
        const prevRect = previousPositions.get(teamId);
        const nextRect = nextPositions.get(teamId);
        const rankChanged = card.dataset.rankChanged === '1';

        if (prevRect && nextRect) {
          applyFlip(card, prevRect, nextRect, rankChanged);
        } else {
          card.style.transition = 'none';
          card.style.setProperty('--translate-y', '20px');
          card.style.setProperty('--scale', '0.92');
          requestAnimationFrame(() => {
            card.classList.add('ranking-floating');
            card.style.transition = `transform ${transitionTiming}, box-shadow ${transitionTiming}`;
            card.style.setProperty('--translate-y', '0px');
            card.style.setProperty('--scale', '1');
            setRankText(card, card.dataset.pendingRank);

            const onEnd = (event) => {
              if (event.propertyName !== 'transform') return;
              card.removeEventListener('transitionend', onEnd);
              card.classList.remove('ranking-floating');
              card.style.removeProperty('--scale');
            };
            card.addEventListener('transitionend', onEnd, { once: true });
          });
        }

        delete card.dataset.rankChanged;
      });
    }

    async function fetchRankings() {
      try {
        const response = await fetch("{% url 'competition:rankings' competition.code %}");
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        renderRankings(data);
      } catch (err) {
        console.error('Rankings fetch error:', err);
      }
    }

    {% if teams %}
    await fetchRankings();
    {% endif %}

    function updateScores(updatedScores) {
      if (!updatedScores || !updatedScores.problem) {
        return;
      }

      const problemId = updatedScores.problem;

      if (updatedScores.team_best !== undefined) {
        $(`#team-best-${problemId}`).text(updatedScores.team_best ?? '--');
      }
      if (updatedScores.user_best !== undefined) {
        $(`#user-best-${problemId}`).text(updatedScores.user_best ?? '--');
      }
      if (updatedScores.competition_best !== undefined) {
        $(`#competition-best-${problemId}`).text(updatedScores.competition_best ?? '--');
      }
    }

    scoreSocket.onopen = () => {
      console.log('Connected to scores WebSocket');
    };

    scoreSocket.onmessage = (event) => {
      try {
        const payload = JSON.parse(event.data);
        if (payload.rankings) {
          renderRankings(payload.rankings);
        } else {
          updateScores(payload);
        }
      } catch (err) {
        console.error('WebSocket message error:', err);
      }
    };

    scoreSocket.onclose = () => {
      console.warn('Scores WebSocket connection closed');
    };
  });
</script>

<div class="container py-5">
  
  <h1 class="text-center">Problems</h1>

  {% if not problems %}
  <div class="mt-1 mb-5"> 
    <h2 class="text-center">No Problems</h2>
  </div>
  {% endif %}

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    {% if user.is_superuser %}
      <div class="col">
        <div class="card h-100 bg-body-tertiary d-flex justify-content-center align-items-center card-border">
          <button class="w-100 h-100 d-flex justify-content-center align-items-center border-0 bg-transparent add-problem" 
                  data-bs-toggle="modal" data-bs-target="#add-problems">
            <i class="bi bi-plus plus-icon"></i>
          </button>
        </div>
      </div>
    {% endif %}
    {% if problems %}
      {% for problem in problems %}
        <div class="col">
          <div
            class="card h-100 bg-body-tertiary"
          >
         
            <div class="card-body">
              <h2 class="card-title">Problem {{ problem.number }}: <br>{{ problem.name }}</h2>
              <p class="card-text">{{ problem.description|truncatechars:100 }}</p> 
              {% if download and user_team or is_competition_over or user.is_superuser %}

                  <a  href="{% url 'competition:download' competition.code problem.name %}" class="d-block">
                    <h2>Download</h2>               
                  </a>

              {% endif %}
            <br>
              {% if upload %}
                  <div>
                    <button class="btn btn-primary" class="upload-submission" data-bs-toggle="modal" data-bs-target="#submission" data-number="{{ problem.number }}" data-name="{{ problem.name }}">
                     Upload
                    </button>

                    <a class="mt-1 btn btn-primary" href="{% url 'competition:output' competition.code problem.name %}">
                        View Output for {{ problem.name|escapejs }}
                    </a>
                  </div>
              {% endif %}
            </div>
            <div class="card-footer">
              {% if problem.score_preference %}
                <i class="bi bi-arrow-up"></i> Higher Score is Better
              {% else %}
                <i class="bi bi-arrow-down"></i> Lower Score is Better
              {% endif %}
              <br>

        
              {% if user_team %}
                Team Best: <span id="team-best-{{ problem.id }}">{{ problem.team_best_score|default:"--" }}</span>
                <br>
                Your Best: <span id="user-best-{{ problem.id }}">{{ problem.user_best_score|default:"--" }}</span>
              {% endif %}
              <br>
              Competition Best: <span id="competition-best-{{ problem.id }}">{{ problem.competition_best_score|default:"--" }}</span>


            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}

  </div>

  <div class="mt-1">
    <h1 class="text-center">Rankings</h1>
  </div>
  <div class="row row-cols-1 g-4">
    {% if teams %}
    <div id="rankings" class="rankings-wrapper">
    </div>
    {% else %}
      <h2 class="text-center">No Teams</h2>
    {% endif %}
  </div>
</div>



{% include 'judgy/includes/add_problems.html' %}
{% include 'judgy/includes/submission.html' %}

{% endblock %}
