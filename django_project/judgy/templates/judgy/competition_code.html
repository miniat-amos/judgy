{% extends 'judgy/base_competition.html' %}

{% block title %}{{ competition.name }}{% endblock %}

{% block style %}

<style>

  .card-border {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card-border:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    border-color: white;
  }

  .ranking-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .ranking-card.ranking-updated {
    transform: translateY(-4px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
  }
 
  .plus-icon { 
    font-size: 200px; 
  }

</style>


{% endblock %}

{% block main_competition %}

<script>
  $(async () => {
    {% if submission_form %}
    $('#submission').on('show.bs.modal', event => {
      const $trigger = $(event.relatedTarget);
      $('#submission .title').text(`${$trigger.data('number')}. ${$trigger.data('name')}`);
      $('#submission')
        .closest('form')
        .attr(
          'action',
          "{% url 'competition:submit' competition.code 'problem.name' %}".replace(
            'problem.name',
            $trigger.data('name')
          )
        );
    });
    {% else %}
    $('[data-bs-target="#submission"]').remove();
    $('#submission').closest('form').remove();
    {% endif %}

    $('#submit-submission').on('submit', async function (e) {
      e.preventDefault();

      const form = $(this);
      const actionUrl = form.closest('form').attr('action');
      const fileInput = $('#user-submission-files')[0];
      const files = fileInput.files;
      const formData = new FormData();

      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }

      try {
        const response = await fetch(actionUrl, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: formData,
        });

        await response.json();
        $('#submission').modal('hide');
        form.trigger('reset');
      } catch (err) {
        console.error('Upload error:', err);
        alert('Error submitting file.');
      }

      return false;
    });

    const competitionCode = '{{ competition.code }}';
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const scoreSocket = new WebSocket(`${wsScheme}://${window.location.host}/ws/scores/${competitionCode}/`);
    const rankingsContainer = $('#rankings');
    const teamUrlTemplate = "{% url 'competition:team_name' competition.code 'team.name' %}";

    function teamUrl(teamName) {
      return teamUrlTemplate.replace('team.name', encodeURIComponent(teamName));
    }

    function buildMembersHtml(members) {
      if (!members || !members.length) {
        return `
          <div class="col">
            <div class="text-center text-muted">
              <i class="bi bi-person-circle" style="font-size: 4rem"></i>
              <h4>â€”</h4>
            </div>
          </div>
        `;
      }

      return members
        .map(
          (member) => `
        <div class="col">
          <div class="text-center">
            <i class="bi bi-person-circle" style="font-size: 4rem"></i>
            <h4>${member}</h4>
          </div>
        </div>
      `
        )
        .join('');
    }

    function updateRankingCard($card, team) {
      $card.attr('data-team-id', team.team_id);
      $card.attr('data-rank', team.rank);
      $card.find('.team-rank').text(`Rank: #${team.rank}`);
      const $teamLink = $card.find('.team-name');
      $teamLink.text(team.team_name);
      $teamLink.attr('href', teamUrl(team.team_name));
      $card.find('.rank-members').html(buildMembersHtml(team.members));
    }

    function createRankingCard(team) {
      const $card = $(`
        <div class="card bg-body-tertiary ranking-card mb-3" data-team-id="${team.team_id}" data-rank="${team.rank}">
          <div class="card-body">
            <h2 class="card-title team-rank"></h2>
            <h3 class="card-title">
              Team:
              <a class="text-decoration-none team-name" href="#"></a>
            </h3>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 rank-members"></div>
          </div>
        </div>
      `);
      updateRankingCard($card, team);
      return $card;
    }

    function renderRankings(rankings) {
      if (!rankingsContainer.length) {
        return;
      }

      const existingCards = new Map();
      rankingsContainer.children('[data-team-id]').each(function () {
        const $card = $(this);
        existingCards.set($card.data('team-id'), $card);
      });

      const seenTeams = new Set();

      rankings.forEach((team) => {
        const teamId = team.team_id;
        let $card = existingCards.get(teamId);

        if ($card) {
          updateRankingCard($card, team);
        } else {
          $card = createRankingCard(team);
        }

        seenTeams.add(teamId);
        rankingsContainer.append($card);
        $card.addClass('ranking-updated');
        setTimeout(() => $card.removeClass('ranking-updated'), 350);
      });

      existingCards.forEach(($card, teamId) => {
        if (!seenTeams.has(teamId)) {
          $card.remove();
        }
      });
    }

    async function fetchRankings() {
      try {
        const response = await fetch("{% url 'competition:rankings' competition.code %}");
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        renderRankings(data);
      } catch (err) {
        console.error('Rankings fetch error:', err);
      }
    }

    {% if teams %}
    await fetchRankings();
    {% endif %}

    function updateScores(updatedScores) {
      if (!updatedScores || !updatedScores.problem) {
        return;
      }

      const problemId = updatedScores.problem;

      if (updatedScores.team_best !== undefined) {
        $(`#team-best-${problemId}`).text(updatedScores.team_best ?? '--');
      }
      if (updatedScores.user_best !== undefined) {
        $(`#user-best-${problemId}`).text(updatedScores.user_best ?? '--');
      }
      if (updatedScores.competition_best !== undefined) {
        $(`#competition-best-${problemId}`).text(updatedScores.competition_best ?? '--');
      }
    }

    scoreSocket.onopen = () => {
      console.log('Connected to scores WebSocket');
    };

    scoreSocket.onmessage = (event) => {
      try {
        const payload = JSON.parse(event.data);
        if (payload.rankings) {
          renderRankings(payload.rankings);
        } else {
          updateScores(payload);
        }
      } catch (err) {
        console.error('WebSocket message error:', err);
      }
    };

    scoreSocket.onclose = () => {
      console.warn('Scores WebSocket connection closed');
    };
  });
</script>

<div class="container py-5">
  
  <h1 class="text-center">Problems</h1>

  {% if not problems %}
  <div class="mt-1 mb-5"> 
    <h2 class="text-center">No Problems</h2>
  </div>
  {% endif %}

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    {% if user.is_superuser %}
      <div class="col">
        <div class="card h-100 bg-body-tertiary d-flex justify-content-center align-items-center card-border">
          <button class="w-100 h-100 d-flex justify-content-center align-items-center border-0 bg-transparent add-problem" 
                  data-bs-toggle="modal" data-bs-target="#add-problems">
            <i class="bi bi-plus plus-icon"></i>
          </button>
        </div>
      </div>
    {% endif %}
    {% if problems %}
      {% for problem in problems %}
        <div class="col">
          <div
            class="card h-100 bg-body-tertiary"
          >
         
            <div class="card-body">
              <h2 class="card-title">Problem {{ problem.number }}: <br>{{ problem.name }}</h2>
              <p class="card-text">{{ problem.description|truncatechars:100 }}</p> 
              {% if download and user_team or is_competition_over or user.is_superuser %}

                  <a  href="{% url 'competition:download' competition.code problem.name %}" class="d-block">
                    <h2>Download</h2>               
                  </a>

              {% endif %}
            <br>
              {% if upload %}
                  <div>
                    <button class="btn btn-primary" class="upload-submission" data-bs-toggle="modal" data-bs-target="#submission" data-number="{{ problem.number }}" data-name="{{ problem.name }}">
                     Upload
                    </button>

                    <a class="mt-1 btn btn-primary" href="{% url 'competition:output' competition.code problem.name %}">
                        View Output for {{ problem.name|escapejs }}
                    </a>
                  </div>
              {% endif %}
            </div>
            <div class="card-footer">
              {% if problem.score_preference %}
                <i class="bi bi-arrow-up"></i> Higher Score is Better
              {% else %}
                <i class="bi bi-arrow-down"></i> Lower Score is Better
              {% endif %}
              <br>

        
              {% if user_team %}
                Team Best: <span id="team-best-{{ problem.id }}">{{ problem.team_best_score|default:"--" }}</span>
                <br>
                Your Best: <span id="user-best-{{ problem.id }}">{{ problem.user_best_score|default:"--" }}</span>
              {% endif %}
              <br>
              Competition Best: <span id="competition-best-{{ problem.id }}">{{ problem.competition_best_score|default:"--" }}</span>


            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}

  </div>

  <div class="mt-1">
    <h1 class="text-center">Rankings</h1>
  </div>
  <div class="row row-cols-1 g-4">
    {% if teams %}
    <div id="rankings">
    </div>
    {% else %}
      <h2 class="text-center">No Teams</h2>
    {% endif %}
  </div>
</div>



{% include 'judgy/includes/add_problems.html' %}
{% include 'judgy/includes/submission.html' %}

{% endblock %}
