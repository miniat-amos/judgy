{% extends 'judgy/base_competition.html' %}

{% block title %}{{ competition.name }}{% endblock %}

{% block style %}

<style>

  .card-border {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .card-border:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    border-color: white;
  }
 
  .plus-icon { 
    font-size: 200px; 
  }

</style>


{% endblock %}

{% block main_competition %}

<script>
  $(async () => {
    '{% if submission_form %}'
      $('#submission').on('show.bs.modal', event => {
        $('#submission .title').text(`${$(event.relatedTarget).data('number')}. ${$(event.relatedTarget).data('name')}`);
        $('#submission').closest('form').attr('action', "{% url 'competition:submit' competition.code 'problem.name' %}".replace('problem.name', $(event.relatedTarget).data('name')));
      });
    '{% else %}'
      $('[data-bs-target="#submission"]').remove();$(event.relatedTarget).data('name')
      $('#submission').closest('form').remove();
    '{% endif %}'

      $('#submit-submission').on('submit', async function (e) {
        e.preventDefault(); // stop normal form post

        const form = $(this);
        const actionUrl = form.closest('form').attr('action');
        const fileInput = $("#user-submission-files")[0];
        const files = fileInput.files;
        const formData = new FormData();

        for (let i = 0; i < files.length; i++) {
          formData.append('files', files[i]);
        }

        try {
          const response = await fetch(actionUrl, {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
          });

          const data = await response.json();

          $('#submission').modal('hide');
          form.trigger('reset');

        } catch (err) {
          console.error('Upload error:', err);
          alert('Error submitting file.');
        }

        return false; 
    });


    

    '{% if teams %}'
      const response = await fetch("{% url 'competition:rankings' competition.code %}");
      const rankings = await response.json();

      
      $('#rankings').empty();

        for (const team of rankings) {
          const members = team.members
          let membersHTML = ""

          for (const member of members) {
            membersHTML += `
              <div class="col">
                <div class="text-center">
                  <i class="bi bi-person-circle" style="font-size: 4rem"></i>
                  <h4>${member}</h4>
                </div>
              </div>
              `
          }
          $('#rankings').append(`
            <div
              class="card  bg-body-tertiary"
            >
          
              <div class="card-body">
                <h2 class="card-title">Rank: #${team.rank}</h2>
                <h3 class="card-title">Team: <a class="text-decoration-none" href=${"{% url 'competition:team_name' competition.code 'team.name' %}".replace('team.name', encodeURIComponent(team.team_name))}>
                  ${team.team_name}
                  </a>
                </h3>
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                  ${membersHTML}

                </div>
              </div>
            </div>
          </div>
          <br>
          `);
        }

    '{% endif %}'


    const competitionCode = "{{ competition.code }}";
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const scoreSocket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/scores/${competitionCode}/`);

    scoreSocket.onopen = function(e) {
      console.log("Connected to scores WebSocket");
    }

    scoreSocket.onmessage = function(event) {
      const updated_scores = JSON.parse(event.data);
      console.log(updated_scores);
    }

 
  });
</script>

<div class="container py-5">
  
  <h1 class="text-center">Problems</h1>

  {% if not problems %}
  <div class="mt-1 mb-5"> 
    <h2 class="text-center">No Problems</h2>
  </div>
  {% endif %}

  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    {% if user.is_superuser %}
      <div class="col">
        <div class="card h-100 bg-body-tertiary d-flex justify-content-center align-items-center card-border">
          <button class="w-100 h-100 d-flex justify-content-center align-items-center border-0 bg-transparent add-problem" 
                  data-bs-toggle="modal" data-bs-target="#add-problems">
            <i class="bi bi-plus plus-icon"></i>
          </button>
        </div>
      </div>
    {% endif %}
    {% if problems %}
      {% for problem in problems %}
        <div class="col">
          <div
            class="card h-100 bg-body-tertiary"
          >
         
            <div class="card-body">
              <h2 class="card-title">Problem {{ problem.number }}: <br>{{ problem.name }}</h2>
              <p class="card-text">{{ problem.description|truncatechars:100 }}</p> 
              {% if download and user_team or is_competition_over or user.is_superuser %}

                  <a  href="{% url 'competition:download' competition.code problem.name %}" class="d-block">
                    <h2>Download</h2>               
                  </a>

              {% endif %}
            <br>
              {% if upload %}
                  <div>
                    <button class="btn btn-primary" class="upload-submission" data-bs-toggle="modal" data-bs-target="#submission" data-number="{{ problem.number }}" data-name="{{ problem.name }}">
                     Upload
                    </button>

                    <a class="mt-1 btn btn-primary" href="{% url 'competition:output' competition.code problem.name %}">
                        View Output for {{ problem.name|escapejs }}
                    </a>
                  </div>
              {% endif %}
            </div>
            <div class="card-footer">
              {% if problem.score_preference %}
                <i class="bi bi-arrow-up"></i> Higher Score is Better
              {% else %}
                <i class="bi bi-arrow-down"></i> Lower Score is Better
              {% endif %}
              <br>

              {% if user_team %}
                    <p>Team Best: {{ problem.team_best_score|default:"--" }}</p>
                    <br>
                    Your Best: {{ problem.user_best_score|default:"--" }}
              {% endif %}

              <br>
              Competition Best: {{ problem.competition_best_score|default:"--" }}

            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}

  </div>

  <div class="mt-1">
    <h1 class="text-center">Rankings</h1>
  </div>
  <div class="row row-cols-1 g-4">
    {% if teams %}
    <div id="rankings">
    </div>
    {% else %}
      <h2 class="text-center">No Teams</h2>
    {% endif %}
  </div>
</div>



{% include 'judgy/includes/add_problems.html' %}
{% include 'judgy/includes/submission.html' %}

{% endblock %}


